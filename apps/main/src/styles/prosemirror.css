/**
 * ProseMirror Editor Styles
 * 
 * This file contains all styling for the ProseMirror rich text editor.
 * Styles are organized by category and support both light and dark modes.
 * 
 * CSS Custom Properties (defined in theme.css) can be used for user-configurable values.
 */

/* ==========================================================================
   CSS Custom Properties for Editor Customization
   ========================================================================== */

:root {
  /* Editor Layout */
  --pm-padding: 0.5rem;
  --pm-line-height: 1;
  
  /* Typography */
  --pm-font-family: consolas;
  --pm-font-size: 14px;
  --pm-zoom: 1;
  --pm-heading-font-family: inherit;
  
  /* Spacing */
  --pm-paragraph-spacing: 0.08em;
  --pm-block-spacing: 0.08em;
  
  /* Cursor */
  --pm-cursor-width: 2px;
  
  /* Colors - Light Mode */
  --pm-text-color: inherit;
  --pm-caret-color: #22c55e;
  --pm-link-color: #3b82f6;
  --pm-link-hover-color: #2563eb;
  --pm-code-bg: rgba(175, 184, 193, 0.2);
  --pm-code-color: #e01e5a;
  --pm-blockquote-border: #ccc;
  --pm-blockquote-text: #666;
  --pm-selection-bg: #b4d5fe;
  --pm-active-line-bg: rgba(0, 0, 0, 0.04);
}

.dark {
  /* Colors - Dark Mode */
  --pm-link-color: #60a5fa;
  --pm-link-hover-color: #93c5fd;
  --pm-code-bg: rgba(110, 118, 129, 0.4);
  --pm-code-color: #ff6b9d;
  --pm-blockquote-border: #555;
  --pm-blockquote-text: #aaa;
  --pm-selection-bg: #264f78;
  --pm-active-line-bg: rgba(255, 255, 255, 0.04);
}

/* ==========================================================================
   Base Editor Styles
   ========================================================================== */

.ProseMirror {
  height: 100%;
  min-height: 100%;
  padding: var(--pm-padding);
  outline: none;
  font-family: var(--pm-font-family);
  font-size: var(--pm-font-size);
  line-height: var(--pm-line-height);
  color: var(--pm-text-color);
  caret-color: var(--pm-caret-color);
  word-wrap: break-word;
  overflow-wrap: break-word;
  /* Note: zoom is applied to parent container so cursor scales too */
}

/* Line wrapping variants - applied dynamically */
.ProseMirror.wrap-enabled {
  white-space: pre-wrap;
  overflow-x: hidden;
}

.ProseMirror.wrap-disabled {
  white-space: pre;
  overflow-x: auto;
}

/* Hide cursor when editor is not focused */
.ProseMirror:not(.ProseMirror-focused) {
  caret-color: transparent;
}

/* Selection styling */
.ProseMirror ::selection {
  background: var(--pm-selection-bg);
}

/* Tight selection - hides native selection and uses decorations instead */
/* Must target both the element itself AND descendants to catch all selection areas */
.ProseMirror.tight-selection-enabled::selection,
.ProseMirror.tight-selection-enabled ::selection,
.ProseMirror.tight-selection-enabled *::selection {
  background: transparent !important;
}

.ProseMirror.tight-selection-enabled::-moz-selection,
.ProseMirror.tight-selection-enabled ::-moz-selection,
.ProseMirror.tight-selection-enabled *::-moz-selection {
  background: transparent !important;
}

/* Custom tight selection decoration */
/* Uses box-shadow for full line-height extension */
/* With line-height: 1 and typical font metrics, text is ~0.7em tall centered in 1em line */
.pm-tight-selection {
  background-color: var(--pm-selection-bg);
  border-radius: 0;
  position: relative;
  /* Define shared selection extension values - increased to close gaps */
  --selection-extend-top: calc(0.2em + 0.5 * var(--pm-paragraph-spacing, 0.08em));
  --selection-extend-bottom: calc(0.25em + 0.5 * var(--pm-paragraph-spacing, 0.08em));
  box-shadow: 
    0 calc(-1 * var(--selection-extend-top)) 0 var(--pm-selection-bg),
    0 var(--selection-extend-bottom) 0 var(--pm-selection-bg);
}

/* Full-height selection - used for non-list paragraphs to ensure proper height */
.pm-tight-selection-line {
  position: relative;
}

/* Selected inline nodes (images, etc) */
.pm-tight-selection-node {
  outline: 2px solid var(--pm-selection-bg);
  outline-offset: 1px;
}

/* Empty lines within selection - shows a thin vertical bar indicator */
/* Extended vertically to connect with adjacent selected lines */
.pm-tight-selection-empty-line {
  position: relative;
}

.pm-tight-selection-empty-line::after {
  content: "";
  position: absolute;
  left: 0;
  /* Extend vertically to match text selection extension */
  top: calc(-1 * (0.2em + 0.5 * var(--pm-paragraph-spacing, 0.08em)));
  bottom: calc(-1 * (0.25em + 0.5 * var(--pm-paragraph-spacing, 0.08em)));
  width: 2px;
  background-color: var(--pm-selection-bg);
  border-radius: 1px;
}

/* List items with selected content - extend selection to cover bullet markers */
/* Create stacking context on li so z-index works relative to it */
li.pm-tight-selection-list-item {
  isolation: isolate;
}

/* Use ::before pseudo-element on first selected text to extend into bullet area */
/* This sits behind the ::marker due to z-index: -1 */
li.pm-tight-selection-list-item .pm-tight-selection:first-child::before {
  content: "";
  position: absolute;
  top: calc(-1 * var(--selection-extend-top, 0.24em));
  bottom: calc(-1 * var(--selection-extend-bottom, 0.29em));
  left: -1.5em;
  width: 1.5em;
  background-color: var(--pm-selection-bg);
  pointer-events: none;
  z-index: -1;
}

/* ==========================================================================
   Active Line Highlight
   ========================================================================== */

/* Highlight the block containing the cursor */
.pm-active-line {
  position: relative;
  /* Create stacking context so z-index: -1 works relative to this element */
  isolation: isolate;
}

/* Use pseudo-element to extend highlight beyond content without affecting layout */
/* Only show when active line highlight is enabled via .pm-active-line-enabled on :root */
:root.pm-active-line-enabled .pm-active-line::before {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  /* Use viewport width centered, clipped by parent overflow */
  left: 50%;
  width: 100vw;
  transform: translateX(-50%);
  background-color: var(--pm-active-line-bg);
  border-radius: 0;
  pointer-events: none;
  z-index: -1;
}

/* Don't show active line when editor is not focused */
.ProseMirror:not(.ProseMirror-focused) .pm-active-line::before {
  background-color: transparent;
}

/* ==========================================================================
   Custom Cursor
   ========================================================================== */

/* Hide native caret when custom cursor is enabled */
.ProseMirror.custom-cursor-enabled {
  caret-color: transparent !important;
}

/* Custom cursor base styles - absolutely positioned to avoid layout issues */
.pm-custom-cursor {
  position: absolute;
  width: var(--pm-cursor-width);
  background-color: var(--pm-caret-color);
  pointer-events: none;
  z-index: 10;
}

/* Block cursor style - applied when :root has .pm-cursor-block-mode */
:root.pm-cursor-block-mode .pm-custom-cursor {
  width: 0.6em;
  opacity: 0.5;
}

/* Animation classes - applied to :root based on settings */

/* Blink animation - classic on/off */
:root.pm-cursor-blink .pm-custom-cursor {
  animation: cursor-blink 1s steps(1) infinite;
}

@keyframes cursor-blink {
  0%, 50% {
    opacity: 1;
  }
  51%, 100% {
    opacity: 0;
  }
}

/* Smooth blink animation - fade in/out */
:root.pm-cursor-smooth .pm-custom-cursor {
  animation: cursor-smooth 1s ease-in-out infinite;
}

@keyframes cursor-smooth {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.2;
  }
}

/* Expand animation - grows and shrinks */
:root.pm-cursor-expand .pm-custom-cursor {
  animation: cursor-expand 1s ease-in-out infinite;
}

@keyframes cursor-expand {
  0%, 100% {
    transform: scaleY(1);
    opacity: 1;
  }
  50% {
    transform: scaleY(0.7);
    opacity: 0.5;
  }
}

/* Solid - no animation */
:root.pm-cursor-solid .pm-custom-cursor {
  animation: none;
  opacity: 1;
}

/* Smooth cursor movement transition */
:root.pm-cursor-smooth-movement .pm-custom-cursor {
  transition: left 80ms ease-out, top 80ms ease-out;
}

/* Hide cursor when editor loses focus */
.ProseMirror:not(.ProseMirror-focused) .pm-custom-cursor {
  opacity: 0 !important;
  animation: none !important;
}

/* ==========================================================================
   Block Elements
   ========================================================================== */

/* Paragraphs */
.ProseMirror p {
  margin: var(--pm-paragraph-spacing) 0;
}

/* Legacy heading support (for parsing old content) */
/* These are converted to paragraphs with fontSize marks, but just in case */
.ProseMirror h1,
.ProseMirror h2,
.ProseMirror h3,
.ProseMirror h4,
.ProseMirror h5,
.ProseMirror h6 {
  font-weight: bold;
  margin: var(--pm-paragraph-spacing) 0;
}

/* Lists */
.ProseMirror ul {
  margin: 0;
  padding-left: 1.5em;
  list-style-type: disc;
}

.ProseMirror ol {
  margin: 0;
  padding-left: 1.5em;
  list-style-type: decimal;
}

.ProseMirror li {
  margin: 0;
  padding: 0;
  display: list-item;
}

/* Smaller, more subtle bullet markers */
.ProseMirror li::marker {
  font-size: 0.8em;
  color: var(--pm-text-color);
}

/* When list item has a specific font-size mark on its content,
   the marker should follow. This works because li inherits from its content. */
/* Keep same spacing as regular paragraphs */
.ProseMirror li > p,
.ProseMirror li > * {
  margin: var(--pm-paragraph-spacing) 0;
}

/* Nested unordered lists - cycle through different bullet styles */
/* Level 1: disc (default), Level 2: circle, Level 3: square, then repeat */
.ProseMirror ul ul,
.ProseMirror ol ul {
  list-style-type: circle;
}

.ProseMirror ul ul ul,
.ProseMirror ol ul ul,
.ProseMirror ul ol ul,
.ProseMirror ol ol ul {
  list-style-type: square;
}

.ProseMirror ul ul ul ul,
.ProseMirror ol ul ul ul,
.ProseMirror ul ol ul ul,
.ProseMirror ol ol ul ul,
.ProseMirror ul ul ol ul,
.ProseMirror ol ul ol ul,
.ProseMirror ul ol ol ul,
.ProseMirror ol ol ol ul {
  list-style-type: disc;
}

/* Nested ordered lists - cycle through: numbers, letters, roman numerals */
/* Level 1: decimal (1, 2, 3), Level 2: lower-alpha (a, b, c), Level 3: lower-roman (i, ii, iii) */
.ProseMirror ol ol,
.ProseMirror ul ol {
  list-style-type: lower-alpha;
}

.ProseMirror ol ol ol,
.ProseMirror ul ol ol,
.ProseMirror ol ul ol,
.ProseMirror ul ul ol {
  list-style-type: lower-roman;
}

.ProseMirror ol ol ol ol,
.ProseMirror ul ol ol ol,
.ProseMirror ol ul ol ol,
.ProseMirror ul ul ol ol,
.ProseMirror ol ol ul ol,
.ProseMirror ul ol ul ol,
.ProseMirror ol ul ul ol,
.ProseMirror ul ul ul ol {
  list-style-type: decimal;
}

/* Blockquotes */
.ProseMirror blockquote {
  border-left: 3px solid var(--pm-blockquote-border);
  margin: var(--pm-block-spacing) 0;
  padding: 0.25em 0 0.25em 1em;
  color: var(--pm-blockquote-text);
  font-style: italic;
}

/* Horizontal rules */
.ProseMirror hr {
  border: none;
  border-top: 2px solid var(--pm-blockquote-border);
  margin: 1.5em 0;
}

/* ==========================================================================
   Inline Marks
   ========================================================================== */

/* Bold */
.ProseMirror strong {
  font-weight: bold;
}

/* Italic */
.ProseMirror em {
  font-style: italic;
}

/* Underline (custom mark) - inherit color for decoration line */
.ProseMirror u,
.ProseMirror .underline {
  text-decoration: underline;
  color: inherit;
}

/* Strikethrough (custom mark) - inherit color for decoration line */
.ProseMirror s,
.ProseMirror del,
.ProseMirror .strikethrough {
  text-decoration: line-through;
  color: inherit;
}

/* Inline code */
.ProseMirror code {
  background-color: var(--pm-code-bg);
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
  font-size: 0.85em;
  color: var(--pm-code-color);
}

/* Links */
.ProseMirror a {
  color: var(--pm-link-color);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
}

.ProseMirror a:hover {
  color: var(--pm-link-hover-color);
  text-decoration-thickness: 2px;
}

/* Text color marks (for future implementation) */
.ProseMirror .text-color {
  /* Color applied via inline style */
}

/* Highlight/background color marks */
.ProseMirror mark {
  /* Ensure mark inherits text color from parent (for text color + highlight combo) */
  color: inherit;
  /* Background applied via inline style */
  padding: 0.1em 0;
  border-radius: 2px;
}

/* Legacy class-based highlight (for future implementation) */
.ProseMirror .highlight {
  /* Background applied via inline style */
  padding: 0.1em 0;
  border-radius: 2px;
}

/* ==========================================================================
   Code Blocks
   ========================================================================== */

.ProseMirror .code-block-container {
  overflow: hidden;
  margin: var(--pm-block-spacing) 0;
  border-radius: 6px;
}

.ProseMirror .code-block-container .cm-editor {
  background: transparent !important;
}

.ProseMirror .code-block-container .cm-gutters {
  background: rgba(0, 0, 0, 0.05);
}

.dark .ProseMirror .code-block-container .cm-gutters {
  background: rgba(255, 255, 255, 0.05);
}

/* Selected code block */
.ProseMirror-selectednode .code-block-container {
  outline: 2px solid #3b82f6;
}

/* ==========================================================================
   ProseMirror UI Elements
   ========================================================================== */

/* Gap cursor (cursor between nodes) */
.ProseMirror-gapcursor {
  display: none;
  pointer-events: none;
  position: absolute;
}

.ProseMirror-gapcursor:after {
  content: "";
  display: block;
  position: absolute;
  top: -2px;
  width: 20px;
  border-top: 1px solid var(--pm-caret-color);
  animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

.ProseMirror-focused .ProseMirror-gapcursor {
  display: block;
}

/* Hide native browser spell-check squiggles on selection */
.ProseMirror [contenteditable]:focus {
  outline: none;
}

/* Placeholder text (for empty documents) */
.ProseMirror p.is-empty::before {
  content: attr(data-placeholder);
  float: left;
  color: #adb5bd;
  pointer-events: none;
  height: 0;
}

.dark .ProseMirror p.is-empty::before {
  color: #6c757d;
}

/* ==========================================================================
   Search Highlights
   ========================================================================== */

.search-match {
  background-color: rgba(255, 215, 0, 0.4); /* Gold/yellow highlight */
  border-radius: 2px;
}

.dark .search-match {
  background-color: rgba(255, 215, 0, 0.3);
}

.search-match-current {
  background-color: rgba(255, 140, 0, 0.6); /* Orange for current match */
  box-shadow: 0 0 0 1px rgba(255, 140, 0, 0.8);
}

.dark .search-match-current {
  background-color: rgba(255, 140, 0, 0.5);
  box-shadow: 0 0 0 1px rgba(255, 140, 0, 0.7);
}

/* ==========================================================================
   Search Bar
   ========================================================================== */

.search-bar {
  position: absolute;
  top: 8px;
  right: 8px;
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background-color: white;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.dark .search-bar {
  background-color: #1f2937;
  border-color: #4b5563;
}

.search-input {
  width: 180px;
  padding: 4px 8px;
  font-size: 13px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background-color: white;
  color: #111827;
  outline: none;
}

.search-input:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.dark .search-input {
  background-color: #374151;
  border-color: #4b5563;
  color: #f3f4f6;
}

.dark .search-input:focus {
  border-color: #60a5fa;
  box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
}

.search-match-count {
  font-size: 12px;
  color: #6b7280;
  min-width: 70px;
  text-align: center;
}

.dark .search-match-count {
  color: #9ca3af;
}

.search-nav-btn,
.search-close-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  padding: 0;
  border: none;
  border-radius: 4px;
  background-color: transparent;
  color: #6b7280;
  cursor: pointer;
  transition: background-color 0.15s, color 0.15s;
}

.search-nav-btn:hover:not(:disabled),
.search-close-btn:hover {
  background-color: #f3f4f6;
  color: #111827;
}

.search-nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.dark .search-nav-btn,
.dark .search-close-btn {
  color: #9ca3af;
}

.dark .search-nav-btn:hover:not(:disabled),
.dark .search-close-btn:hover {
  background-color: #374151;
  color: #f3f4f6;
}

